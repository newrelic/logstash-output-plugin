# Ruby
# Package your Ruby project.
# Add steps that install rails, analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/ruby

trigger:
- master

pool:
  vmImage: 'macOS-latest'

steps:
- task: UseRubyVersion@0
  inputs:
    versionSpec: '>= 2.5'
    addToPath: true

- script: |
    brew update
    brew install jruby
  displayName: 'Install jruby'

# - script: |
#     git clone https://github.com/rbenv/rbenv.git ~/.rbenv
#   displayName: 'install rbenv'

# - script: |
#     cd ~/.rbenv && src/configure && make -C src
#   displayName: 'move rbenv'

# - script: |
#     echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bash_profile
#   displayName: 'add rbenv to path'

- script: |
    source ~/.bashrc
    source ~/.bash_profile
    jruby -S gem install bundler
  displayName: 'jruby install bundler'

- script: |
    jruby -S bundle install
  displayName: 'Install dependencies'

- script: jruby -S bundle exec rake
  displayName: 'bundle exec rake'
# - script: |
#     source ~/.bashrc
#     source ~/.bash_profile
#     jruby -S bundle exec rspec spec --format RspecJunitFormatter --out test_results/TEST-rspec.xml
#   displayName: 'Run tests'

- task: PublishTestResults@2
  condition: succeededOrFailed()
  inputs:
    testResultsFiles: '**/test-*.xml'
    testRunTitle: 'Ruby tests'
# - task: PublishTestResults@2
#   inputs:
#     testResultsFormat: 'JUnit'
#     testResultsFiles: '**/TEST-*.xml'
#     testRunTitle: 'Rspec'