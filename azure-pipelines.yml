# Ruby
# Package your Ruby project.
# Add steps that install rails, analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/ruby

trigger:
- master

pool:
  vmImage: 'macOS-latest'

steps:
# - task: UseRubyVersion@0
#   inputs:
#     versionSpec: '>= 2.5'
#     addToPath: true


- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      brew update
      brew install rbenv
      echo '' >> ~/.bash_profile
      echo 'eval "$(rbenv init -)"' >> ~/.bash_profile
      echo '---------------- ~/.bash_profile ----------------'
      cat ~/.bash_profile
      echo '-------------------------------------------------'
      echo '---------------- which jruby --------------------'
      which jruby
      echo '-------------------------------------------------'
    noProfile: false
    noRc: false
  displayName: 'Install rbenv'

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      rbenv install jruby-9.2.5.0
      rbenv global jruby-9.2.5.0
      echo '---------------- ~/.bash_profile ----------------'
      cat ~/.bash_profile
      echo '-------------------------------------------------'
      echo '---------------- which jruby --------------------'
      which jruby
      echo '-------------------------------------------------'
    noProfile: false
    noRc: false
  displayName: 'Install JRuby'
# - bash: |
#     rbenv install jruby-9.2.5.0
#     rbenv global jruby-9.2.5.0
#   displayName: 'Install JRuby'
#   noProfile: false

# - script: |
#     git clone https://github.com/rbenv/rbenv.git ~/.rbenv
#   displayName: 'install rbenv'

# - script: |
#     cd ~/.rbenv && src/configure && make -C src
#   displayName: 'move rbenv'

# - script: |
#     echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bash_profile
#   displayName: 'add rbenv to path'

    # source ~/.bashrc
    # source ~/.bash_profile

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      echo '---------------- ~/.bash_profile ----------------'
      cat ~/.bash_profile
      echo '-------------------------------------------------'
      echo '---------------- which jruby --------------------'
      which jruby
      echo '-------------------------------------------------'
      jruby -S gem install bundler
    noProfile: false
    noRc: false
  displayName: 'Install bundler'
# - bash: |
#     jruby -S gem install bundler
#   displayName: 'Install bundler'
#   noProfile: false
- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      jruby -S bundle install
    noProfile: false
    noRc: false
  displayName: 'Install dependencies'
# - bash: |
#     jruby -S bundle install
#   displayName: 'Install dependencies'
#   noProfile: false
- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      jruby -S bundle exec rspec
    noProfile: false
    noRc: false
  displayName: 'Run tests'
# - bash: |
#     jruby -S bundle exec rspec
#   displayName: 'Run tests'
#   noProfile: false

# - task: PublishTestResults@2
#   condition: succeededOrFailed()
#   inputs:
#     testResultsFiles: '**/test-*.xml'
#     testRunTitle: 'Ruby tests'
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/TEST-*.xml'
    testRunTitle: 'Rspec'