# Ruby
# Package your Ruby project.
# Add steps that install rails, analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/ruby

trigger:
- master

pool:
  vmImage: 'macOS-latest'

steps:

- task: Bash@3
  displayName: 'Install rbenv'
  inputs:
    targetType: 'inline'
    script: |
      brew update
      brew install rbenv
      # echo 'eval "$(rbenv init -)"' >> ~/.bashrc

- task: Bash@3
  displayName: 'Install JRuby'
  inputs:
    targetType: 'inline'
    script: |
      rbenv install jruby-9.2.5.0
      rbenv global jruby-9.2.5.0

# - bash: |
#     rbenv install jruby-9.2.5.0
#     rbenv global jruby-9.2.5.0
#   displayName: 'Install JRuby'
#   noProfile: false

# - script: |
#     git clone https://github.com/rbenv/rbenv.git ~/.rbenv
#   displayName: 'install rbenv'

# - script: |
#     cd ~/.rbenv && src/configure && make -C src
#   displayName: 'move rbenv'

# - script: |
#     echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bash_profile
#   displayName: 'add rbenv to path'

    # source ~/.bashrc
    # source ~/.bash_profile

- task: Bash@3
  displayName: 'Install bundler'
  inputs:
    targetType: 'inline'
    script: |
      eval "$(rbenv init -)"
      jruby -S gem install bundler
      
# - bash: |
#     jruby -S gem install bundler
#   displayName: 'Install bundler'
#   noProfile: false
- task: Bash@3
  displayName: 'Install dependencies'
  inputs:
    targetType: 'inline'
    script: |
      eval "$(rbenv init -)"
      jruby -S bundle install

# - bash: |
#     jruby -S bundle install
#   displayName: 'Install dependencies'
#   noProfile: false
- task: Bash@3
  displayName: 'Run tests'
  inputs:
    targetType: 'inline'
    script: |
      eval "$(rbenv init -)"
      jruby -S bundle exec rspec

# - bash: |
#     jruby -S bundle exec rspec
#   displayName: 'Run tests'
#   noProfile: false

# - task: PublishTestResults@2
#   condition: succeededOrFailed()
#   inputs:
#     testResultsFiles: '**/test-*.xml'
#     testRunTitle: 'Ruby tests'
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/TEST-*.xml'
    testRunTitle: 'Rspec'