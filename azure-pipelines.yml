# Ruby
# Package your Ruby project.
# Add steps that install rails, analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/ruby

trigger:
- master

pool:
  vmImage: 'macOS-latest'

steps:
- task: UseRubyVersion@0
  inputs:
    versionSpec: '>= 2.5'
    addToPath: true

- script: |
    brew update
    brew install rbenv
  displayName: 'Install rbenv'

- script: |
    rbenv install jruby-9.2.5.0
    rbenv local jruby-9.2.5.0
  displayName: 'Install JRuby'

# - script: |
#     git clone https://github.com/rbenv/rbenv.git ~/.rbenv
#   displayName: 'install rbenv'

# - script: |
#     cd ~/.rbenv && src/configure && make -C src
#   displayName: 'move rbenv'

# - script: |
#     echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bash_profile
#   displayName: 'add rbenv to path'

    # source ~/.bashrc
    # source ~/.bash_profile
- script: |
    ruby -S gem install bundler
  displayName: 'Install bundler'

- script: |
    ruby -S bundle install
  displayName: 'Install dependencies'

    # source ~/.bashrc
    # source ~/.bash_profile
- script: |
    ruby -S bundle exec rspec
  displayName: 'Run tests'

# - task: PublishTestResults@2
#   condition: succeededOrFailed()
#   inputs:
#     testResultsFiles: '**/test-*.xml'
#     testRunTitle: 'Ruby tests'
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/TEST-*.xml'
    testRunTitle: 'Rspec'